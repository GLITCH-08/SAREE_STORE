<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Saree Store - Upload Product</title>
    <style>
      body {
        font-family: system-ui, sans-serif;
        background: #f5f5f5;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
      }
      .card {
        background: white;
        padding: 20px;
        border-radius: 12px;
        width: 360px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
      }
      .card h1 {
        margin-top: 0;
        font-size: 1.2rem;
      }
      label {
        display: block;
        font-size: 0.9rem;
        margin-top: 10px;
      }
      input,
      textarea {
        width: 100%;
        padding: 8px;
        margin-top: 4px;
        border-radius: 8px;
        border: 1px solid #ddd;
        font-family: inherit;
      }
      button {
        margin-top: 12px;
        padding: 10px;
        border-radius: 999px;
        border: none;
        cursor: pointer;
        background: #1a73e8;
        color: white;
        font-size: 1rem;
        width: 100%;
      }
      .status {
        margin-top: 10px;
        font-size: 0.85rem;
      }
      .status.error {
        color: #d93025;
      }
      .status.success {
        color: #188038;
      }
      #signin-button {
        margin-bottom: 8px;
        background: #fff;
        color: #444;
        border: 1px solid #ddd;
      }
    </style>
  </head>
  <body>
    <div class="card">
      <h1>Saree Upload</h1>

      <button id="signin-button" disabled>Sign in with Google</button>

      <form id="upload-form">
        <label>
          Title
          <input type="text" name="title" required />
        </label>

        <label>
          Description
          <textarea name="description" rows="3"></textarea>
        </label>

        <label>
          Price
          <input type="number" step="0.01" name="price" />
        </label>

        <label>
          Tags (comma separated)
          <input type="text" name="tags" placeholder="saree, silk, bridal" />
        </label>

        <label>
          Image
          <input type="file" name="image" id="image-input" accept="image/*" required />
        </label>

        <button type="submit">Upload</button>
        <div class="status" id="status"></div>
      </form>
    </div>

    <!-- Load Google API client (for Drive) -->
    <script
      src="https://apis.google.com/js/api.js"
      async
      defer
      onload="gapiLoaded()"
    ></script>

    <!-- Load Google Identity Services (new auth) -->
    <script
      src="https://accounts.google.com/gsi/client"
      async
      defer
      onload="gisLoaded()"
    ></script>

    <script>
      // TODO: replace with your real values
      const API_KEY = "AIzaSyDSZQI5dCI9G7fmsTMpdAyLd9LsJLRF47E";
      const CLIENT_ID = "874399168252-oo7eh41di7i4e16tiqvbfp10bopj4fql.apps.googleusercontent.com";
      const SCOPES = "https://www.googleapis.com/auth/drive.file";
      const DRIVE_FOLDER_ID = "1enrDxAbKJonC38-_jshLL94DgM1YNLoE";

      const signinButton = document.getElementById("signin-button");
      const form = document.getElementById("upload-form");
      const statusEl = document.getElementById("status");
      const imageInput = document.getElementById("image-input");

      let gapiInited = false;
      let gisInited = false;
      let tokenClient = null;
      let accessToken = null;
      let isAuthorized = false;

      // Called when gapi script loads
      function gapiLoaded() {
        gapi.load("client", initializeGapiClient);
      }

      async function initializeGapiClient() {
        try {
          await gapi.client.init({
            apiKey: API_KEY,
            discoveryDocs: [
              "https://www.googleapis.com/discovery/v1/apis/drive/v3/rest",
            ],
          });
          gapiInited = true;
          maybeEnableSignIn();
        } catch (err) {
          console.error("gapi init error:", err);
          statusEl.textContent =
            "Error initializing Google API client (Drive). Check console.";
        }
      }

      // Called when GIS script loads
      function gisLoaded() {
        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: CLIENT_ID,
          scope: SCOPES,
          callback: (resp) => {
            if (resp.error) {
              console.error("Token error:", resp);
              statusEl.textContent = "Error getting access token.";
              return;
            }
            accessToken = resp.access_token;
            isAuthorized = true;
            statusEl.textContent = "Signed in & authorized. You can upload now.";
            signinButton.textContent = "Authorized";
            signinButton.disabled = true;
          },
        });
        gisInited = true;
        maybeEnableSignIn();
      }

      function maybeEnableSignIn() {
        if (gapiInited && gisInited) {
          signinButton.disabled = false;
          statusEl.textContent = "Click 'Sign in with Google' to authorize Drive.";
          signinButton.onclick = () => {
            // Always prompt user to choose account & consent at least first time
            tokenClient.requestAccessToken({ prompt: "consent" });
          };
        }
      }

      async function uploadFileToDrive(file) {
        if (!isAuthorized || !accessToken) {
          throw new Error("Not authorized for Drive. Please sign in first.");
        }

        statusEl.textContent = "Uploading image to Google Drive...";

        const metadata = {
        name: file.name,
        mimeType: file.type,
        parents: [DRIVE_FOLDER_ID], // ðŸ‘ˆ put it inside SareeCatalogImages
        };
        const formData = new FormData();
        formData.append(
          "metadata",
          new Blob([JSON.stringify(metadata)], { type: "application/json" })
        );
        formData.append("file", file);

        const res = await fetch(
          "https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name,webViewLink",
          {
            method: "POST",
            headers: new Headers({
              Authorization: "Bearer " + accessToken,
            }),
            body: formData,
          }
        );

        if (!res.ok) {
          const errorText = await res.text();
          console.error("Drive upload error:", errorText);
          throw new Error("Drive upload failed");
        }

        return await res.json(); // {id, name, webViewLink}
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const file = imageInput.files[0];
        if (!file) {
          statusEl.textContent = "Please choose an image file.";
          return;
        }

        if (!isAuthorized) {
          statusEl.textContent =
            "Please sign in with Google and authorize Drive access first.";
          return;
        }

        try {
          // 1. Upload image to Drive
          const driveFile = await uploadFileToDrive(file);

          // 2. Send details + Drive info to backend
          const formData = new FormData(form);
          const payload = {
            title: formData.get("title"),
            description: formData.get("description"),
            price: formData.get("price"),
            tags: formData.get("tags"),
            imageDriveId: driveFile.id,
            imageUrl: `https://drive.google.com/uc?export=view&id=${driveFile.id}`,
          };

          statusEl.textContent = "Saving product to database...";

          const res = await fetch("/api/save-product", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
          });

          const data = await res.json();
          if (!res.ok) {
            throw new Error(data.error || "Save product failed");
          }

          statusEl.className = "status success";
          statusEl.innerHTML =
            "Saved!<br>Image URL: <a href='" +
            data.product.imageUrl +
            "' target='_blank'>Open in Drive</a>";

          form.reset();
        } catch (err) {
          console.error(err);
          statusEl.className = "status error";
          statusEl.textContent = "Error: " + err.message;
        }
      });
    </script>
  </body>
</html>
